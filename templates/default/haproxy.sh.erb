#!/usr/bin/bash

PATH="/opt/local/bin:/opt/local/sbin:/usr/bin:/usr/sbin";

# Set field delimiters to line breaks
OLDIFS=$IFS
LINEBREAKS=$( echo -en "\n\b" )
IFS=$LINEBREAKS

# get all backends from all proxies
backends=`echo "show stat -1 2 -1" | nc -U /var/run/haproxy.sock`
for backend in $backends; do

  # skip comments and headers
  if [[ "$backend" = "#"* ]]; then continue; fi

  IFS=","
  DATA=( `echo "${backend}"` )
  PREFIX="haproxy:${DATA[0]}:backend:"

  echo -e "${PREFIX}bytes_in\tL\t${DATA[8]}"
  echo -e "${PREFIX}bytes_out\tL\t${DATA[9]}"
  echo -e "${PREFIX}queued\tL\t${DATA[2]}"
  echo -e "${PREFIX}session_rate\tL\t${DATA[33]}"
  echo -e "${PREFIX}sessions\tL\t${DATA[4]}"
  echo -e "${PREFIX}session_limit\tL\t${DATA[5]}"
  echo -e "${PREFIX}conn_err\tL\t${DATA[13]}"
  echo -e "${PREFIX}resp_err\tL\t${DATA[14]}"
  echo -e "${PREFIX}downtime\tL\t${DATA[24]}"
  echo -e "${PREFIX}status\ts\t${DATA[17]}"
  echo -e "${PREFIX}checks_down\tL\t${DATA[22]}"

done

# restore field delimiter
IFS=$OLDIFS
