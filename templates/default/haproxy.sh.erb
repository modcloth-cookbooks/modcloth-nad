#!/usr/bin/bash

PATH="/opt/local/bin:/opt/local/sbin:/usr/bin:/usr/sbin";

DATA=`echo "show stat" | nc -U /var/run/haproxy.sock | grep BACKEND | grep app_servers`

BYTES_IN=`echo ${DATA} | awk -F"," '{print $9}'`
BYTES_OUT=`echo ${DATA} | awk -F"," '{print $10}'`
QUEUED=`echo ${DATA} | awk -F"," '{print $3}'`
SESSION_RATE=`echo ${DATA} | awk -F"," '{print $34}'`
SESSIONS=`echo ${DATA} | awk -F"," '{print $5}'`
CONN_ERR=`echo ${DATA} | awk -F"," '{print $14}'`
RESP_ERR=`echo ${DATA} | awk -F"," '{print $15}'`

PREFIX="unix:0:haproxy:"

echo -e "${PREFIX}bytes_in\tn\t${BYTES_IN}"
echo -e "${PREFIX}bytes_out\tn\t${BYTES_OUT}"
echo -e "${PREFIX}queued\tn\t${QUEUED}"
echo -e "${PREFIX}session_rate\tn\t${SESSION_RATE}"
echo -e "${PREFIX}sessions\tn\t${SESSIONS}"
echo -e "${PREFIX}conn_err\tn\t${CONN_ERR}"
echo -e "${PREFIX}resp_err\tn\t${RESP_ERR}"
